---
layout: post
title: Node.jsé›†æˆthriftæ¡†æ¶
subtitle: å…³äºä½¿ç”¨nodeé›†æˆthriftè°ƒç”¨rpcæ¥å£çš„ç®€å•æ•™ç¨‹
date: 2019-04-13
author: Bug
header-img: img/posts/2019-04-12.jpg
catalog: true
tags:
    - webå‰ç«¯
    - Node.js
    - RPC
    - Thrift
---

# å‰è¨€

åšè¿™ä¸ªäº‹æƒ…å…¶å®çº¯å±ä¸ªäººå…´è¶£ ğŸ˜ƒï¼Œä»¥ä¸‹è®²çš„ä¸»è¦æ˜¯æœ¬äººåœ¨ä½¿ç”¨ node.js æ¥åš thrift client ç«¯è°ƒç”¨å…¬å¸å†…éƒ¨ rpc æ¡†æ¶æ—¶ï¼Œæ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µå’Œé—®é¢˜ã€‚

# å…³äº rpc

RPCï¼ˆRemote Procedure Callï¼‰â€”è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œå»ºç«‹åœ¨ tcp åè®®åŸºç¡€ä¸Šï¼Œæ¯” http æ›´è½»é‡ã€æ›´å¿«é€Ÿï¼Œæƒ³äº†è§£æ›´å¤šçš„å¯ä»¥çœ‹ä¸‹è¿™ç¯‡åšå®¢â€”[RPC åŸç†è¯¦è§£](http://www.cnblogs.com/metoy/p/4321311.html)ã€‚

# å…³äº thrift çš„ä¸€äº›æ¦‚å¿µ

Thrift æ˜¯ Facebook å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„ rpc æ¡†æ¶ï¼Œå‡ ä¹è¦†ç›–äº†ä¸»æµçš„æ‰€æœ‰è¯­è¨€ï¼Œå®ƒæœ‰ä¸€ä¸ªä»£ç ç”Ÿæˆå™¨æ¥å¯¹å®ƒæ‰€å®šä¹‰çš„**IDLï¼ˆInterface description languageï¼Œæ¥å£æè¿°è¯­è¨€ï¼‰å®šä¹‰æ–‡ä»¶**è‡ªåŠ¨ç”ŸæˆæœåŠ¡ä»£ç æ–‡ä»¶ã€‚

### TBufferedTransport å’Œ TFramedTransport

éƒ½æ˜¯ç»§æ‰¿ç¼“å†²åŸºç±» TBufferBase çš„å­ç±»ï¼Œå…·ä½“æºç ã€å·®å¼‚æ¨èä»¥ä¸‹ä¸¤ç¯‡åšå®¢â€”[thrift ä¹‹ TTransport å±‚çš„ç¼“å­˜ä¼ è¾“ç±» TBufferedTransport å’Œç¼“å†²åŸºç±» TBufferBase](https://blog.csdn.net/qiangweiloveforever/article/details/9476003)ã€[thrift ä¹‹ TTransport å±‚çš„åˆ†å¸§ä¼ è¾“ç±» TFramedTransport](http://www.cnblogs.com/brucewoo/archive/2013/07/31/3226856.html)

### TBinaryProtocol å’Œ TCompactProtocol

thrift ç”¨æ¥å¤„ç†æ•°æ®åºåˆ—åŒ–çš„åè®®ï¼ŒTBinaryProtocol æ˜¯é»˜è®¤åè®®ï¼ŒTCompactProtocol ä½œä¸º TBinaryProtocol åè®®çš„å‡çº§å¼ºåŒ–ç‰ˆï¼Œé‡‡ç”¨äº†ä¸€ç§å« ZigZag çš„å»å‹ç¼©æ•´æ•°ï¼Œè¿™ç¯‡åšå®¢ä»‹ç»äº† TCompactProtocol ä¸ºä½•æ›´ä¼˜ [Thrift äºŒè¿›åˆ¶åºåˆ—åŒ– TCompactProtocol ä¸ TBinaryProtocol çš„åŸç†å’ŒåŒºåˆ«](https://my.oschina.net/venwyhk/blog/751790)

# æ­£æ–‡

äº†è§£å®Œæ¥ä¸‹æ¥å¯èƒ½ä¼šé‡åˆ°çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„æ­£äº‹ï¼Œä½¿ç”¨ node.js å»é›†æˆ thriftã€‚

### å®‰è£… thrift

æœ¬äººçš„ç”µè„‘æ˜¯ macï¼Œæ‰€ä»¥å®‰è£…æ¯”è¾ƒç®€å•ï¼Œbrew ç›´æ¥å®‰è£…å³å¯

    brew install thrift

å…¶ä»– linuxã€windows ç³»ç»Ÿå®‰è£…ï¼Œå¯ä»¥å»ç½‘ä¸Šçœ‹ä¸‹æ•™ç¨‹ï¼Œæœ‰å¾ˆå¤šã€‚

### ç¼–å†™ä¸€ä¸ª IDL æ–‡ä»¶

thrift çš„ IDL æ–‡ä»¶æ˜¯ä»¥.thrift ç»“å°¾çš„æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®ç›®å½•ä¸‹ç®€å•çš„å®šä¹‰ä¸€ä¸ªå« account.thrift çš„æ–‡ä»¶ï¼Œå†™å…¥ä¸€ä¸ªç®€å•çš„ struct å’Œæ–¹æ³•ã€‚

    struct TAccountRpcDTO {
    1: i64 uid,
    2: string name,
    }

    service TAccountService {
        // åˆ›å»ºä¸€ä¸ªè´¦å·
        void createAccount(1: TAccountRpcDTO tAccountRpcDTO);

        // è·å–æŸä¸ªè´¦å·
        TAccountRpcDTO getAccount(1: i64 uid);
    }

### ä½¿ç”¨ thrift ç”Ÿæˆ js æ–‡ä»¶

js ç‰ˆæœ¬

    thrift --gen js:node account.thrift

ts ç‰ˆæœ¬

thrift --gen js:ts account.thrift

### å®‰è£…å®˜æ–¹ä¾èµ–åŒ…

    yarn add thrift

### åˆ›å»ºä¸€ä¸ª thrift_server

åˆ›å»ºä¸€ä¸ª js æ–‡ä»¶ï¼Œç”¨ä½œ thrift çš„ server ç«¯ï¼Œå»å¼€å¯ rpc æœåŠ¡ï¼Œæä¾›æ¥å£ã€‚

    const thrift = require('thrift');

    // å¼•å…¥ç”Ÿæˆçš„structå’Œserviceæ–¹æ³•
    const TAccountService = require('./gen-nodejs/TAccountService'),
    	TAccountTypes = require('./gen-nodejs/account_types');

    // æ¨¡æ‹Ÿæ•°æ®åº“ï¼Œæœ¬åœ°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ä½œå­˜å‚¨account
    const accounts = {};

    // å¼€å¯rpc server
    const server = thrift.createServer(TAccountService, {
    	createAccount(account, result) {
    		console.log('server createAccount:', account.uid);

    		accounts[account.uid] = account;
    		result(null);
    	},

    	getAccount(uid, result) {
    		console.log('server getAccount:', uid);

    		result(null, accounts[uid]);
    	},
    });

    // ç›‘å¬3030ç«¯å£
    server.listen(3030);

### åˆ›å»ºä¸€ä¸ª thrift_client

åˆ›å»ºä¸€ä¸ª js æ–‡ä»¶ç”¨ä½œ client ç«¯è°ƒç”¨åˆšåˆšå®šä¹‰å¥½çš„ rpc æ–¹æ³•ã€‚

    const thrift = require('thrift');

    // å¼•å…¥ç”Ÿæˆçš„structå’Œserviceæ–¹æ³•
    const TAccountService = require('./gen-nodejs/TAccountService'),
    	TAccountTypes = require('./gen-nodejs/account_types');

    // å»ºç«‹è¿æ¥å’Œåˆå§‹åŒ–client
    const connection = thrift.createConnection('localhost', 3030),
    	client = thrift.createClient(TAccountService, connection);

    // å®šä¹‰ä¸€ä¸ªæ–°çš„accountDtoå¯¹è±¡ï¼Œç”¨ä½œæµ‹è¯•
    const account = new TAccountTypes.TAccountRpcDTO({
    	uid: 1,
    	name: 'Hello World',
    });

    // ç›‘å¬erroräº‹ä»¶ï¼Œnodeçš„NodeJS.EventEmitterç±»çš„onæ–¹æ³•
    connection.on('error', err => {
    	console.error(err);
    });

    // è°ƒç”¨serverç«¯çš„createAccountæ–¹æ³•
    client.createAccount(account, err => {
    	if (err) {
    		console.error(err);
    		return;
    	}

    	console.log('client createAccount:', account.uid);

    	// è·å–åˆšåˆšâ€æ–°å»ºâ€œçš„account
    	client.getAccount(account.uid, (err, resp) => {
    		if (err) {
    			console.error(err);
    			return;
    		}

    		console.log(`client getAccount: uid=${resp.uid}, name=${resp.name}`);
    		connection.end();
    	});
    });

### è¿è¡Œæ•ˆæœ

å…ˆå¯åŠ¨ thrift_server

    node server.js

å†æ‰§è¡Œ thrift_clientï¼Œå°±èƒ½çœ‹åˆ°æ•ˆæœ

    node client.js

##### ä»¥ä¸‹æ˜¯æ•ˆæœå›¾ï¼š

server ç«¯è¿è¡Œæ•ˆæœå›¾ï¼š

![serverç«¯è¿è¡Œæ•ˆæœå›¾](http://fdfs.xmcdn.com/group60/M09/76/DE/wKgLb1yx1yDxfaWvAAKDMwfAGL4183.jpg)

client ç«¯è¿è¡Œæ•ˆæœå›¾ï¼š

![clientç«¯è¿è¡Œæ•ˆæœå›¾](http://fdfs.xmcdn.com/group59/M07/77/13/wKgLeFyx1t6hnyCWAAFISC9F1bY314.jpg)

### åˆ‡æ¢ transport å’Œ protocol

åˆ°ä¸Šé¢ä¸ºæ­¢ï¼Œæœ€ç®€å•çš„ä¸€ä¸ª thrift è°ƒç”¨å·²ç»å®Œæˆï¼Œå¦‚æœæƒ³è¦è¿›è¡Œä¸€äº› option çš„é…ç½®ï¼ˆè¿™é‡Œä¸»è¦æŒ‡ client ç«¯ï¼‰ï¼Œthrift.createConnection()æœ‰ç¬¬ä¸‰ä¸ªå‚æ•° options å¯ä¾›ä½¿ç”¨ã€‚

createConnection()çš„å¤´æ–‡ä»¶å®šä¹‰ï¼š

    export function createConnection(host: string | undefined, port: number, options?: ConnectOptions): Connection;

ç„¶åæ˜¯ ConnectOptions çš„æ¥å£å®šä¹‰ï¼š

    export interface ConnectOptions {
        transport?: TTransportConstructor;
        protocol?: TProtocolConstructor;
        path?: string;
        headers?: HttpHeaders;
        https?: boolean;
        debug?: boolean;
        max_attempts?: number;
        retry_max_delay?: number;
        connect_timeout?: number;
        timeout?: number;
        nodeOptions?: http.RequestOptions | https.RequestOptions;
    }

å¯ä»¥çœ‹åˆ°ï¼Œtransportã€protocol éƒ½æ˜¯å¯ä»¥åœ¨ options é‡Œè¿›è¡Œé…ç½®çš„ï¼Œè€Œé»˜è®¤ä½¿ç”¨çš„åˆ™æ˜¯ TBufferedTransport å’Œ TBinaryProtocolã€‚

# æ€»ç»“

å…¶å®æœ¬æ¥æ²¡æƒ³å†™è¿™ç¯‡åšå®¢æ¥ç€ï¼Œè¿˜æ˜¯å½“åšç»ƒæ‰‹å§ã€‚ã€‚ã€‚ä»¥ä¸Šéƒ½æ˜¯ä¸€äº›æç®€çš„ä»‹ç»å’Œæ¡ˆä¾‹ï¼Œæ— è®ºæ˜¯ rpc è¿˜æ˜¯å„ç§ rpc æ¡†æ¶ï¼Œå…¶å®éœ€è¦å­¦ä¹ çš„ã€éœ€è¦æŒ–æ˜çš„æœ‰å¾ˆå¤šã€‚
